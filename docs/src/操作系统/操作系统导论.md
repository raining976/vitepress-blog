# 操作系统导论

> [!TIP]
>
> 本文将从 虚拟化（virtulization）、并发（concurrency）、持久性（persistence）这部分介绍操作系统是如何进行工作的，包括如何决定接下来哪个程序使用cpu，如何在虚拟内存系统中处理内存使用过载，虚拟机监控器如何工作，如何处理磁盘上的数据等等。

操作系统三个设计目标

1. 建立抽象，方便程序使用
2. 提供高性能
3. 在应用程序之间以及os和应用之间提供保护

## 虚拟化

什么是虚拟化，操作系统可以认为是一个通用的计算机软件，它向其他更接近用户层的应用程序提供了许多通用的接口，操作系统允许程序共享内存、允许程序与设备进行交互等等，不同的程序对计算机资源的使用要求可能是不同的，因此我们希望对于不同需求的应用程序所能看到的资源都是一样的形式，这也算是一种透明，虚拟化就是做了一件这样的事：它让物理资源（处理器、内存、磁盘等）转换为更加通用、更强大且更容易使用的虚拟形式。无非虚拟化cpu就是让每个应用程序都认为自己是独占cpu的，虚拟化内存让每个程序都认为自己是独占内存空间的，程序与程序之间不知道对方的存在。

### 虚拟化cpu

在讲虚拟化cpu之前，我们首先要介绍一个对于前文提到的“应用程序”的一种抽象：进程。

#### 进程

进程是操作系统提供的最基本的抽象，进程的定义也非常的简单：<u>进程就是运行中的程序。</u>程序本身是没有生命周期的，本质上是一些指令，是操作系统让程序运行起来从而发挥作用的。

> [!NOTE]
>
> 一个非常常见的需求：多个程序需要同时运行，但是计算机刚发展时是单cpu的，操作系统如何实现每个程序都能“同时”使用到cpu，从而实现我们的需求？

事实上实现这件事也就是实现了虚拟化cpu。

通过让一个进程只运行一小段时间（我们称这一小段时间为一个*时间片*），然后切换到其他进程，这样操作系统也就提供了存在多个cpu的假象。这就是时分共享（time sharing）cpu技术。

辩证的看待这个方案，潜在的问题就是效率降低，因为cpu共享进程就要切换，就会有上下文切换的额外性能损失。

如何高效进行cpu共享，这就需要用到操作系统的一些低阶的机制以及一些高阶的智能。所谓的机制就是”怎么切换进程”，需要配合硬件等实现上下文切换之类的事情；而策略就是“切换哪些进程”，涉及到一些算法，什么时候切换哪些进程。

为了实现我们的终极目标，我们还需要搞清楚：到底什么是进程？

##### 究竟什么是进程？进程需要包含哪些信息？

重申一下：进程就是操作系统对正在运行的程序提供的抽象。进程就是一个正在运行的程序，任何时候，只要我们知道了一个进程访问或者影响了系统的哪些部分，我们也就知道了进程具体是什么了。

为了进一步理解究竟什么是进程，我们就需要理解它每时每刻能影响系统的哪些状态，我们称这些状态为机器状态（machine state）：程序在运行时可以更新或者读取的内容。

所谓进程的机器状态有一个最明显也是最重要的组成部分：<u>内存</u>。程序的指令存在内存中，进程要读写的数据也在内存中，所以进程可以访问的内存也是进程的一部分（很显然，不是吗）

> [!TIP]
>
> 进程能访问的内存也称为地址空间（address space）这部分将在虚拟化内存中详细介绍。

进程的机器状态另一部分就是<u>寄存器</u>。寄存器是一种比所谓的缓存更加高速的缓存硬件。很多时候为了提升计算效率，寄存器也是进程频繁操作的目标，因此也属于进程的一部分。

特别的，有些特殊的寄存器可以认为是每个进程的必需品，比如程序计数器（Program Counter PC有时叫做指令指针，Instruction Pointer IP），栈指针、帧指针等管理函数参数、局部变量和返回地址等，这些也属于进程的一部分。

##### 进程创建要做的一些事情

操作系统创建进程必须要做的第一件事就是将代码和所有静态数据加载到内存中，也就是加载到内存的地址空间中。当然现代操作系统都是惰性加载的，即仅在程序执行期间需要加载某些代码或者数据时才会加载，具体的细节在将来的分页和交换机制中会了解到。（本质上就是只存一个在磁盘中的位置，需要的时候再从磁盘加载，当然存储的信息不只有磁盘位置这么点）

将（必要的）代码和静态数据加载到内存后，操作系统还需要为程序运行时栈分配一些内存，这个栈用来存储程序中的局部变量、函数参数和返回地址中（以c语言为例）。有时操作系统可能会初始化栈中的某些信息，比如main函数的参数列表等。

除了为栈分配内存，还可能会为程序的堆分配内存。C程序中使用malloc显式的为程序分配堆空间。

还有一些其他的初始任务，特别是与I/O相关的任务。比如在UNIX系统，默认情况下每个进程都会有三个打开的文件描述符，用于进行标准的输入、输出和错误。这些描述符可以让程序轻松的读取来自终端的输入以及打印输出到屏幕。关于这部分将在持久化中详细了解。

至此，操作系统终于为程序执行搭建了所有需要的内容，然后最后一件事情就是：启动程序。通过将程序跳转到main函数位置，将cpu控制权交给新创建的进程，从而程序开始执行。

##### 进程有哪些状态

不同的时间进程可能会有不同的表现，这也是为了达到某些目的而使用的一种手段，我们称为进程的状态

- 运行（running）：进程正在处理上运行。
- 就绪（ready）：进程已经准备上执行，但是由于某种原因，操作系统并没有选择在此时执行。
- 阻塞（blocked）：当前进程由于执行了某种操作（比如io操作）而处于的一种状态，直到发生其他事件时才会准备运行。

![image-20241001195028550](https://gitee.com/raining976/markdown-imgs/raw/master/img/image-20241001195028550.png)



## 并发

## 持久